@model TicketDetailViewModel
@{
    ViewData["Title"] = $"Ticket #{Model.Ticket.Id}";
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var isAdmin = User.IsInRole(RoleNames.Admin);
    var isRequester = Model.Ticket.RequesterUserId == currentUserId;
    var isSubscriber = Model.Subscribers.Any(s => s.UserId == currentUserId);
    var canInteract = isAdmin || isRequester || isSubscriber;
    var roleLabel = isAdmin ? "admin" : "requester";
    var header = new PageHeaderViewModel
    {
        Title = $"#{Model.Ticket.Id} {Model.Ticket.Title}",
        Subtitle = $"Requester: {(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)} | Category: {Model.Ticket.Category?.Name} | System: {Model.Ticket.InternalSystem?.Name ?? "Not set"}",
        Actions = @<div class="d-flex flex-wrap gap-2 align-items-center">
            @await Html.PartialAsync("_BadgeStatus", Model.Ticket.Status)
            @await Html.PartialAsync("_BadgePriority", Model.Ticket.Priority)
            @await Html.PartialAsync("_SlaBadge", Model.Ticket)
            @if (Model.Ticket.Status != TicketStatus.Closed)
            {
                <form asp-action="Close" method="post" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <button class="btn btn-outline-danger" type="submit" data-loading-text="Closing..." data-confirm="Close this ticket?">Close</button>
                </form>
            }
            else if (isAdmin || isRequester)
            {
                <form asp-action="Reopen" method="post" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <button class="btn btn-outline-secondary" type="submit" data-loading-text="Reopening..." data-confirm="Reopen this ticket?">Reopen</button>
                </form>
            }
        </div>
    };
}

@await Html.PartialAsync("_PageHeader", header)

<div class="ticket-layout" data-role="@roleLabel">
    <div class="ticket-main">
        <div class="card mb-4">
            <div class="card-header section-title ticket-conversation-header">Conversation</div>
            <div class="card-body">
                <div class="opening-post">
                    <div class="conversation-header">
                        <div>
                            <div class="conversation-label">Opening Post</div>
                            <div class="fw-semibold">@(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)</div>
                        </div>
                        <div class="ticket-meta">@Model.Ticket.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                    </div>
                    <div class="conversation-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(Model.Ticket.Description, Model.AllowedAttachmentIds))</div>
                </div>

                <div class="reply-list" id="comment-thread">
                    @if (!Model.Comments.Any())
                    {
                        @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                        {
                            Title = "No replies yet",
                            Message = "Add the first reply to move this ticket forward."
                        })
                    }
                    else
                    {
                        @foreach (var comment in Model.Comments)
                        {
                            <div class="reply-card">
                                <div class="conversation-header">
                                    <div class="fw-semibold">@(string.IsNullOrWhiteSpace(comment.AuthorUser?.DisplayName) ? comment.AuthorUser?.Email : comment.AuthorUser?.DisplayName)</div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="ticket-meta">@comment.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                        @if (isAdmin || comment.AuthorUserId == currentUserId)
                                        {
                                            <button class="btn btn-link btn-sm p-0 edit-link" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#edit-comment-@comment.Id"
                                                    aria-expanded="false"
                                                    aria-controls="edit-comment-@comment.Id">
                                                Edit
                                            </button>
                                        }
                                    </div>
                                </div>
                                <div class="conversation-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(comment.Body, Model.AllowedAttachmentIds))</div>
                                @if (isAdmin || comment.AuthorUserId == currentUserId)
                                {
                                    <div class="collapse mt-3" id="edit-comment-@comment.Id">
                                        <form asp-action="EditComment" method="post" data-disable-on-submit>
                                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <div class="mb-2">
                                                <label class="form-label">Edit Reply</label>
                                                <textarea class="form-control" name="body" rows="3">@comment.Body</textarea>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Changes</button>
                                                <button class="btn btn-sm btn-light" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#edit-comment-@comment.Id"
                                                        aria-expanded="true"
                                                        aria-controls="edit-comment-@comment.Id">
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>

                @if (canInteract)
                {
                    <form asp-action="AddComment" method="post" class="mt-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <div class="mb-3">
                            <label class="form-label">Add Reply</label>
                            <textarea class="form-control" name="NewComment" rows="4" placeholder="Share updates or ask for details" required id="reply-text"></textarea>
                            <div class="form-text">Tip: paste screenshots here (Ctrl+V).</div>
                            <div class="paste-preview mt-2" id="reply-paste-preview"></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" type="submit" data-loading-text="Posting...">Post Reply</button>
                            <button class="btn btn-outline-secondary" type="reset">Clear</button>
                        </div>
                    </form>
                }
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header section-title">Attachments</div>
            <div class="card-body">
                @if (!Model.Attachments.Any())
                {
                    @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                    {
                        Title = "No attachments",
                        Message = "Upload a file if it helps explain the issue."
                    })
                }
                else
                {
                    <ul class="list-group list-group-flush mb-3">
                        @foreach (var attachment in Model.Attachments)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">@attachment.OriginalFileName</div>
                                    <div class="ticket-meta">Uploaded by @(string.IsNullOrWhiteSpace(attachment.UploadedByUser?.DisplayName) ? attachment.UploadedByUser?.Email : attachment.UploadedByUser?.DisplayName) on @attachment.UploadedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="text-muted">@string.Format("{0:N0} KB", attachment.SizeBytes / 1024)</span>
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="DownloadAttachment" asp-route-id="@Model.Ticket.Id" asp-route-attachmentId="@attachment.Id">Download</a>
                                </div>
                            </li>
                        }
                    </ul>
                }

                @if (canInteract)
                {
                    <form asp-action="UploadAttachment" method="post" enctype="multipart/form-data" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <div class="mb-3">
                            <label class="form-label">Upload Attachment</label>
                            <input type="file" name="attachment" class="form-control" />
                            <div class="form-text">Allowed: pdf, png, jpg, txt, docx, xlsx (max 10MB).</div>
                        </div>
                        <button class="btn btn-outline-primary" type="submit" data-loading-text="Uploading...">Upload</button>
                    </form>
                }
            </div>
        </div>
    </div>
    <div class="ticket-sidebar" id="ticket-sidebar" aria-hidden="false">
        <div class="ticket-sidebar-header">
            <span class="section-title">Ticket Panel</span>
            <button type="button" class="btn btn-sm btn-outline-secondary ticket-sidebar-toggle" aria-expanded="true" aria-controls="ticket-sidebar">
                Hide panel
            </button>
        </div>
        <div class="ticket-sidebar-body">
            <details class="ticket-panel mb-3" open>
                <summary class="ticket-panel-summary">Time Spent</summary>
                <div class="ticket-panel-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Total: @TimeFormatHelper.FormatMinutes(Model.TotalTimeMinutes)</div>
                        @if (isAdmin)
                        {
                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#time-entry-form"
                                    aria-expanded="false"
                                    aria-controls="time-entry-form">
                                Add time
                            </button>
                        }
                    </div>

                    @if (isAdmin)
                    {
                        <div class="collapse mb-3" id="time-entry-form">
                            <form asp-action="AddTimeEntry" asp-route-id="@Model.Ticket.Id" method="post" data-disable-on-submit>
                                <div class="mb-2">
                                    <label class="form-label">Minutes</label>
                                    <input type="number" class="form-control" name="TimeEntryMinutes" min="1" max="1440" required />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Work date</label>
                                    <input type="date" class="form-control" name="TimeEntryWorkDate" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Note (optional)</label>
                                    <input type="text" class="form-control" name="TimeEntryNote" maxlength="200" />
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary" type="submit" data-loading-text="Saving...">Save Entry</button>
                                    <button class="btn btn-sm btn-outline-secondary" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#time-entry-form"
                                            aria-expanded="true"
                                            aria-controls="time-entry-form">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    }

                    @if (!Model.TimeEntries.Any())
                    {
                        <div class="text-muted">No time entries yet.</div>
                    }
                    else
                    {
                        <div class="comment-timeline">
                            @foreach (var entry in Model.TimeEntries)
                            {
                                <div class="comment-card">
                                    <div class="comment-header">
                                        <div class="fw-semibold">@(string.IsNullOrWhiteSpace(entry.User?.DisplayName) ? entry.User?.Email : entry.User?.DisplayName)</div>
                                        <div class="ticket-meta">@entry.WorkDate.ToLocalTime().ToString("MMM d, yyyy")</div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>@TimeFormatHelper.FormatMinutes(entry.Minutes)</div>
                                        @if (!string.IsNullOrWhiteSpace(entry.Note))
                                        {
                                            <div class="ticket-meta">@entry.Note</div>
                                        }
                                    </div>
                                    @if (isAdmin)
                                    {
                                        <div class="mt-2 d-flex gap-2">
                                            <button class="btn btn-link btn-sm p-0 edit-link" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#edit-time-@entry.Id"
                                                    aria-expanded="false"
                                                    aria-controls="edit-time-@entry.Id">
                                                Edit
                                            </button>
                                            <form asp-action="DeleteTimeEntry" asp-route-id="@Model.Ticket.Id" asp-route-entryId="@entry.Id" method="post" data-disable-on-submit>
                                                <button class="btn btn-link btn-sm p-0 text-danger" type="submit" data-confirm="Delete this time entry?">Delete</button>
                                            </form>
                                        </div>
                                        <div class="collapse mt-3" id="edit-time-@entry.Id">
                                            <form asp-action="EditTimeEntry" asp-route-id="@Model.Ticket.Id" asp-route-entryId="@entry.Id" method="post" data-disable-on-submit>
                                                <div class="mb-2">
                                                    <label class="form-label">Minutes</label>
                                                    <input type="number" class="form-control" name="minutes" min="1" max="1440" value="@entry.Minutes" required />
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Work date</label>
                                                    <input type="date" class="form-control" name="workDate" value="@entry.WorkDate.ToString("yyyy-MM-dd")" />
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Note (optional)</label>
                                                    <input type="text" class="form-control" name="note" maxlength="200" value="@entry.Note" />
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Changes</button>
                                                    <button class="btn btn-sm btn-light" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#edit-time-@entry.Id"
                                                            aria-expanded="true"
                                                            aria-controls="edit-time-@entry.Id">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </details>

            @if (User.IsInRole(RoleNames.Admin))
            {
                <details class="ticket-panel mb-3" open>
                    <summary class="ticket-panel-summary">Admin Actions</summary>
                    <div class="ticket-panel-content">
                        <form asp-action="Assign" method="post" class="mb-3" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <label class="form-label">Assign Ticket</label>
                            <select class="form-select" name="AssignToUserId">
                                <option value="">Unassigned</option>
                                @foreach (var admin in Model.Admins)
                                {
                                    <option value="@admin.Value" selected="@(admin.Value == Model.Ticket.AssignedAdminUserId)">@admin.Text</option>
                                }
                            </select>
                            <button class="btn btn-primary mt-2" type="submit" data-loading-text="Saving...">Update Assignment</button>
                        </form>

                        <form asp-action="UpdateStatus" method="post" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <label class="form-label">Update Status</label>
                            <select class="form-select" name="NewStatus">
                                @foreach (var status in Model.Statuses)
                                {
                                    <option value="@status.Value" selected="@(status.Value == Model.Ticket.Status.ToString())">@status.Text</option>
                                }
                            </select>
                            <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Status</button>
                        </form>

                        <form asp-action="UpdatePriority" method="post" class="mt-3" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <label class="form-label">Update Priority</label>
                            <select class="form-select" name="NewPriority">
                                @foreach (var priority in Model.Priorities)
                                {
                                    <option value="@priority.Value" selected="@(priority.Value == Model.Ticket.Priority.ToString())">@priority.Text</option>
                                }
                            </select>
                            <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Priority</button>
                        </form>

                        <form asp-action="UpdateCategory" method="post" class="mt-3" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <label class="form-label">Update Category</label>
                            <select class="form-select" name="NewCategoryId">
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.Value" selected="@(category.Value == Model.Ticket.CategoryId.ToString())">@category.Text</option>
                                }
                            </select>
                            <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Category</button>
                        </form>

                        <form asp-action="UpdateInternalSystem" method="post" class="mt-3" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <label class="form-label">Update Internal System</label>
                            <select class="form-select" name="NewInternalSystemId">
                                <option value="" selected="@(Model.Ticket.InternalSystemId == null)">Not set</option>
                                @foreach (var system in Model.InternalSystems)
                                {
                                    <option value="@system.Value" selected="@(system.Value == Model.Ticket.InternalSystemId?.ToString())">@system.Text</option>
                                }
                            </select>
                            <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change System</button>
                        </form>
                    </div>
                </details>
            }

            <details class="ticket-panel mb-3" open>
                <summary class="ticket-panel-summary">Ticket Overview</summary>
                <div class="ticket-panel-content">
                    <div class="info-grid">
                        <div>
                            <div class="info-label">Requester</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Category</div>
                            <div>@Model.Ticket.Category?.Name</div>
                        </div>
                        <div>
                            <div class="info-label">Internal System</div>
                            <div>@(Model.Ticket.InternalSystem?.Name ?? "Not set")</div>
                        </div>
                        <div>
                            <div class="info-label">Assigned</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.AssignedAdminUser?.DisplayName) ? (Model.Ticket.AssignedAdminUser?.Email ?? "Unassigned") : Model.Ticket.AssignedAdminUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Created</div>
                            <div>@Model.Ticket.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Updated</div>
                            <div>@Model.Ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Reopens</div>
                            <div>@Model.Ticket.ReopenCount</div>
                        </div>
                        @if (Model.Ticket.ReopenedAtUtc.HasValue)
                        {
                            <div>
                                <div class="info-label">Last Reopened</div>
                                <div>@Model.Ticket.ReopenedAtUtc.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                            </div>
                        }
                    <div>
                        <div class="info-label">Status</div>
                        <div class="d-flex gap-2 flex-wrap">
                            @await Html.PartialAsync("_BadgeStatus", Model.Ticket.Status)
                            @await Html.PartialAsync("_BadgePriority", Model.Ticket.Priority)
                        </div>
                    </div>
                    <div>
                        <div class="info-label">Open For</div>
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <span>@SlaHelper.FormatAge(Model.Ticket.CreatedAtUtc, DateTime.UtcNow)</span>
                            @await Html.PartialAsync("_SlaBadge", Model.Ticket)
                        </div>
                    </div>
                    </div>
                </div>
            </details>

            <details class="ticket-panel mb-3" open>
                <summary class="ticket-panel-summary">Subscribers</summary>
                <div class="ticket-panel-content" data-ticket-id="@Model.Ticket.Id">
                    <div class="ticket-meta mb-2">Subscribers can view this ticket and receive updates.</div>
                    <div class="subscriber-list" id="subscriber-list">
                        @if (!Model.Subscribers.Any())
                        {
                            <div class="text-muted">No subscribers yet.</div>
                        }
                        else
                        {
                            @foreach (var subscriber in Model.Subscribers)
                            {
                                <div class="subscriber-item">
                                    <div>
                                        <div class="fw-semibold">@subscriber.DisplayName</div>
                                        <div class="ticket-meta">@subscriber.Email</div>
                                    </div>
                                    @if (Model.CanManageSubscribers)
                                    {
                                        <button class="btn btn-sm btn-outline-danger subscriber-remove"
                                                type="button"
                                                data-user-id="@subscriber.UserId">
                                            Remove
                                        </button>
                                    }
                                </div>
                            }
                        }
                    </div>

                    @if (Model.CanManageSubscribers)
                    {
                        <div class="mt-3">
                            <label class="form-label">Add subscriber</label>
                            <input class="form-control" id="subscriber-search" type="text" placeholder="Search by name or email" autocomplete="off" />
                            <div class="subscriber-results" id="subscriber-results" hidden></div>
                            <div class="form-text">Start typing to find a user.</div>
                            <div class="subscriber-feedback text-muted mt-2" id="subscriber-feedback"></div>
                            <form id="subscriber-antiforgery">
                                @Html.AntiForgeryToken()
                            </form>
                        </div>
                    }
                </div>
            </details>

            @if (User.IsInRole(RoleNames.Admin))
            {
                <details class="ticket-panel note-card" open>
                    <summary class="ticket-panel-summary">Internal Notes</summary>
                    <div class="ticket-panel-content">
                        @if (!Model.InternalNotes.Any())
                        {
                            @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                            {
                                Title = "No internal notes",
                                Message = "Admin-only notes stay hidden from requesters."
                            })
                        }
                        else
                        {
                            <div class="comment-timeline">
                                @foreach (var note in Model.InternalNotes)
                                {
                                    <div class="comment-card note-card-item">
                                        <div class="comment-header">
                                            <div class="fw-semibold">@(string.IsNullOrWhiteSpace(note.AuthorUser?.DisplayName) ? note.AuthorUser?.Email : note.AuthorUser?.DisplayName)</div>
                                            <div class="ticket-meta">@note.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                        </div>
                                        <div class="comment-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(note.Body, Model.AllowedAttachmentIds))</div>
                                        <div class="mt-2">
                                            <button class="btn btn-link btn-sm p-0 edit-link" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#edit-note-@note.Id"
                                                    aria-expanded="false"
                                                    aria-controls="edit-note-@note.Id">
                                                Edit
                                            </button>
                                        </div>
                                        <div class="collapse mt-3" id="edit-note-@note.Id">
                                            <form asp-action="EditInternalNote" method="post" data-disable-on-submit>
                                                <input type="hidden" name="id" value="@Model.Ticket.Id" />
                                                <input type="hidden" name="noteId" value="@note.Id" />
                                                <div class="mb-2">
                                                    <label class="form-label">Edit Internal Note</label>
                                                    <textarea class="form-control" name="body" rows="3">@note.Body</textarea>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Changes</button>
                                                    <button class="btn btn-sm btn-light" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#edit-note-@note.Id"
                                                            aria-expanded="true"
                                                            aria-controls="edit-note-@note.Id">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <form asp-action="AddInternalNote" method="post" class="mt-3" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <div class="mb-3">
                                <label class="form-label">Add Internal Note</label>
                                <textarea class="form-control" name="NewInternalNote" rows="3" placeholder="Add internal-only notes" id="note-text"></textarea>
                                <div class="form-text">Tip: paste screenshots here (Ctrl+V).</div>
                                <div class="paste-preview mt-2" id="note-paste-preview"></div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Note</button>
                                <button class="btn btn-light" type="reset">Clear</button>
                            </div>
                        </form>
                    </div>
                </details>
            }
        </div>
    </div>
    <button type="button" class="ticket-sidebar-handle" id="ticket-sidebar-handle" aria-controls="ticket-sidebar" aria-expanded="false">
        Panel
    </button>
</div>

@section Scripts {
    @if (TempData["Success"] != null && TempData["Success"]?.ToString() == "Comment posted.")
    {
        <script>
            const thread = document.getElementById("comment-thread");
            if (thread) {
                thread.scrollIntoView({ behavior: "smooth", block: "end" });
            }
        </script>
    }
    <script src="~/js/paste-attachments.js" asp-append-version="true"></script>
    <script>
        initPasteUpload({
            textareaSelector: "#reply-text",
            previewSelector: "#reply-paste-preview",
            uploadUrl: "@Url.Action("UploadToTicket", "Attachments", new { ticketId = Model.Ticket.Id })"
        });

        initPasteUpload({
            textareaSelector: "#note-text",
            previewSelector: "#note-paste-preview",
            uploadUrl: "@Url.Action("UploadToTicket", "Attachments", new { ticketId = Model.Ticket.Id })"
        });
    </script>
    <script>
        const layout = document.querySelector(".ticket-layout");
        const sidebar = document.getElementById("ticket-sidebar");
        const toggle = document.querySelector(".ticket-sidebar-toggle");
        const handle = document.getElementById("ticket-sidebar-handle");
        const storageKey = "ticketSidebarCollapsed_v2";

        const setCollapsed = (collapsed) => {
            if (!layout || !sidebar || !toggle || !handle) {
                return;
            }
            layout.classList.toggle("is-collapsed", collapsed);
            layout.classList.toggle("is-open", !collapsed);
            toggle.setAttribute("aria-expanded", (!collapsed).toString());
            handle.setAttribute("aria-expanded", (!collapsed).toString());
            toggle.textContent = collapsed ? "Show panel" : "Hide panel";
            sidebar.setAttribute("aria-hidden", collapsed.toString());
            localStorage.setItem(storageKey, collapsed ? "true" : "false");
        };

        if (layout && sidebar && toggle && handle) {
            const isMobile = window.matchMedia("(max-width: 991px)").matches;
            const stored = localStorage.getItem(storageKey);
            const defaultCollapsed = true;
            const collapsed = stored === null ? defaultCollapsed : stored === "true";
            setCollapsed(collapsed);

            toggle.addEventListener("click", () => {
                setCollapsed(!layout.classList.contains("is-collapsed"));
            });

            handle.addEventListener("click", () => {
                setCollapsed(!layout.classList.contains("is-collapsed"));
            });
        }
    </script>
    <script>
        const subscriberList = document.getElementById("subscriber-list");
        const subscriberResults = document.getElementById("subscriber-results");
        const subscriberSearch = document.getElementById("subscriber-search");
        const subscriberFeedback = document.getElementById("subscriber-feedback");
        const subscriberContainer = document.querySelector(".ticket-panel-content[data-ticket-id]");
        const subscriberForm = document.getElementById("subscriber-antiforgery");
        const ticketId = subscriberContainer?.getAttribute("data-ticket-id");

        const getAntiForgeryToken = () => {
            const input = subscriberForm?.querySelector("input[name='__RequestVerificationToken']");
            return input?.value || "";
        };

        const renderSubscribers = (items) => {
            if (!subscriberList) {
                return;
            }
            if (!items || items.length === 0) {
                subscriberList.innerHTML = "<div class=\"text-muted\">No subscribers yet.</div>";
                return;
            }

            subscriberList.innerHTML = items.map((item) => {
                const removeButton = @Model.CanManageSubscribers.ToString().ToLowerInvariant()
                    ? `<button class="btn btn-sm btn-outline-danger subscriber-remove" type="button" data-user-id="${item.userId}">Remove</button>`
                    : "";
                return `
                    <div class="subscriber-item">
                        <div>
                            <div class="fw-semibold">${item.displayName}</div>
                            <div class="ticket-meta">${item.email || ""}</div>
                        </div>
                        ${removeButton}
                    </div>`;
            }).join("");
        };

        const setFeedback = (message) => {
            if (!subscriberFeedback) {
                return;
            }
            subscriberFeedback.textContent = message || "";
        };

        const updateResults = (items) => {
            if (!subscriberResults) {
                return;
            }
            if (!items || items.length === 0) {
                subscriberResults.hidden = true;
                subscriberResults.innerHTML = "";
                return;
            }
            subscriberResults.hidden = false;
            subscriberResults.innerHTML = items.map((item) => `
                <button class="subscriber-result-item" type="button" data-user-id="${item.userId}">
                    <span>${item.displayName}</span>
                    <span class="ticket-meta">${item.email || ""}</span>
                </button>
            `).join("");
        };

        const searchUsers = async (term) => {
            if (!subscriberResults || !ticketId) {
                return;
            }
            if (!term || term.length < 2) {
                updateResults([]);
                return;
            }
            const response = await fetch(`/users/search?q=${encodeURIComponent(term)}&ticketId=${ticketId}`);
            if (!response.ok) {
                updateResults([]);
                return;
            }
            const data = await response.json();
            updateResults(data);
        };

        const addSubscriber = async (userId) => {
            if (!ticketId) {
                return;
            }
            setFeedback("");
            const response = await fetch(`/tickets/${ticketId}/subscribers`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": getAntiForgeryToken()
                },
                body: JSON.stringify({ userId })
            });

            if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                setFeedback(payload.error || "Unable to add subscriber.");
                return;
            }

            const updated = await response.json();
            renderSubscribers(updated);
            updateResults([]);
            if (subscriberSearch) {
                subscriberSearch.value = "";
            }
            setFeedback("Subscriber added.");
        };

        const removeSubscriber = async (userId) => {
            if (!ticketId) {
                return;
            }
            setFeedback("");
            const response = await fetch(`/tickets/${ticketId}/subscribers/${encodeURIComponent(userId)}`, {
                method: "DELETE",
                headers: {
                    "RequestVerificationToken": getAntiForgeryToken()
                }
            });

            if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                setFeedback(payload.error || "Unable to remove subscriber.");
                return;
            }

            const updated = await response.json();
            renderSubscribers(updated);
            setFeedback("Subscriber removed.");
        };

        if (subscriberSearch) {
            let searchTimer = 0;
            subscriberSearch.addEventListener("input", (event) => {
                window.clearTimeout(searchTimer);
                const term = event.target.value;
                searchTimer = window.setTimeout(() => searchUsers(term), 250);
            });
        }

        if (subscriberResults) {
            subscriberResults.addEventListener("click", (event) => {
                const target = event.target.closest(".subscriber-result-item");
                if (target) {
                    addSubscriber(target.getAttribute("data-user-id"));
                }
            });
        }

        if (subscriberList) {
            subscriberList.addEventListener("click", (event) => {
                const target = event.target.closest(".subscriber-remove");
                if (target) {
                    removeSubscriber(target.getAttribute("data-user-id"));
                }
            });
        }
    </script>
}

