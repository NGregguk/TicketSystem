@model TicketDetailViewModel
@{
    ViewData["Title"] = $"Ticket #{Model.Ticket.Id}";
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var isAdmin = User.IsInRole(RoleNames.Admin);
    var isRequester = Model.Ticket.RequesterUserId == currentUserId;
    var header = new PageHeaderViewModel
    {
        Title = $"#{Model.Ticket.Id} {Model.Ticket.Title}",
        Subtitle = $"Requester: {(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)} | Category: {Model.Ticket.Category?.Name} | System: {Model.Ticket.InternalSystem?.Name ?? "Not set"}",
        Actions = @<div class="d-flex flex-wrap gap-2 align-items-center">
            @await Html.PartialAsync("_BadgeStatus", Model.Ticket.Status)
            @await Html.PartialAsync("_BadgePriority", Model.Ticket.Priority)
            @await Html.PartialAsync("_SlaBadge", Model.Ticket)
            @if (Model.Ticket.Status != TicketStatus.Closed)
            {
                <form asp-action="Close" method="post" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <button class="btn btn-outline-danger" type="submit" data-loading-text="Closing..." data-confirm="Close this ticket?">Close</button>
                </form>
            }
            else if (isAdmin || isRequester)
            {
                <form asp-action="Reopen" method="post" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <button class="btn btn-outline-secondary" type="submit" data-loading-text="Reopening..." data-confirm="Reopen this ticket?">Reopen</button>
                </form>
            }
        </div>
    };
}

@await Html.PartialAsync("_PageHeader", header)

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header section-title">Conversation</div>
            <div class="card-body">
                <div class="opening-post">
                    <div class="conversation-header">
                        <div>
                            <div class="conversation-label">Opening Post</div>
                            <div class="fw-semibold">@(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)</div>
                        </div>
                        <div class="ticket-meta">@Model.Ticket.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                    </div>
                    <div class="conversation-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(Model.Ticket.Description, Model.AllowedAttachmentIds))</div>
                </div>

                <div class="reply-list" id="comment-thread">
                    @if (!Model.Comments.Any())
                    {
                        @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                        {
                            Title = "No replies yet",
                            Message = "Add the first reply to move this ticket forward."
                        })
                    }
                    else
                    {
                        @foreach (var comment in Model.Comments)
                        {
                            <div class="reply-card">
                                <div class="conversation-header">
                                    <div class="fw-semibold">@(string.IsNullOrWhiteSpace(comment.AuthorUser?.DisplayName) ? comment.AuthorUser?.Email : comment.AuthorUser?.DisplayName)</div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="ticket-meta">@comment.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                        @if (isAdmin || comment.AuthorUserId == currentUserId)
                                        {
                                            <button class="btn btn-link btn-sm p-0 edit-link" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#edit-comment-@comment.Id"
                                                    aria-expanded="false"
                                                    aria-controls="edit-comment-@comment.Id">
                                                Edit
                                            </button>
                                        }
                                    </div>
                                </div>
                                <div class="conversation-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(comment.Body, Model.AllowedAttachmentIds))</div>
                                @if (isAdmin || comment.AuthorUserId == currentUserId)
                                {
                                    <div class="collapse mt-3" id="edit-comment-@comment.Id">
                                        <form asp-action="EditComment" method="post" data-disable-on-submit>
                                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <div class="mb-2">
                                                <label class="form-label">Edit Reply</label>
                                                <textarea class="form-control" name="body" rows="3">@comment.Body</textarea>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Changes</button>
                                                <button class="btn btn-sm btn-light" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#edit-comment-@comment.Id"
                                                        aria-expanded="true"
                                                        aria-controls="edit-comment-@comment.Id">
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>

                <form asp-action="AddComment" method="post" class="mt-3" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <div class="mb-3">
                        <label class="form-label">Add Reply</label>
                        <textarea class="form-control" name="NewComment" rows="4" placeholder="Share updates or ask for details" required id="reply-text"></textarea>
                        <div class="form-text">Tip: paste screenshots here (Ctrl+V).</div>
                        <div class="paste-preview mt-2" id="reply-paste-preview"></div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit" data-loading-text="Posting...">Post Reply</button>
                        <button class="btn btn-outline-secondary" type="reset">Clear</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header section-title">Attachments</div>
            <div class="card-body">
                @if (!Model.Attachments.Any())
                {
                    @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                    {
                        Title = "No attachments",
                        Message = "Upload a file if it helps explain the issue."
                    })
                }
                else
                {
                    <ul class="list-group list-group-flush mb-3">
                        @foreach (var attachment in Model.Attachments)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">@attachment.OriginalFileName</div>
                                    <div class="ticket-meta">Uploaded by @(string.IsNullOrWhiteSpace(attachment.UploadedByUser?.DisplayName) ? attachment.UploadedByUser?.Email : attachment.UploadedByUser?.DisplayName) on @attachment.UploadedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="text-muted">@string.Format("{0:N0} KB", attachment.SizeBytes / 1024)</span>
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="DownloadAttachment" asp-route-id="@Model.Ticket.Id" asp-route-attachmentId="@attachment.Id">Download</a>
                                </div>
                            </li>
                        }
                    </ul>
                }

                <form asp-action="UploadAttachment" method="post" enctype="multipart/form-data" data-disable-on-submit>
                    <input type="hidden" name="id" value="@Model.Ticket.Id" />
                    <div class="mb-3">
                        <label class="form-label">Upload Attachment</label>
                        <input type="file" name="attachment" class="form-control" />
                        <div class="form-text">Allowed: pdf, png, jpg, txt, docx, xlsx (max 10MB).</div>
                    </div>
                    <button class="btn btn-outline-primary" type="submit" data-loading-text="Uploading...">Upload</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        @if (User.IsInRole(RoleNames.Admin))
        {
            <div class="card mb-4">
                <div class="card-header section-title">Admin Actions</div>
                <div class="card-body">
                    <form asp-action="Assign" method="post" class="mb-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <label class="form-label">Assign Ticket</label>
                        <select class="form-select" name="AssignToUserId">
                            <option value="">Unassigned</option>
                            @foreach (var admin in Model.Admins)
                            {
                                <option value="@admin.Value" selected="@(admin.Value == Model.Ticket.AssignedAdminUserId)">@admin.Text</option>
                            }
                        </select>
                        <button class="btn btn-primary mt-2" type="submit" data-loading-text="Saving...">Update Assignment</button>
                    </form>

                    <form asp-action="UpdateStatus" method="post" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <label class="form-label">Update Status</label>
                        <select class="form-select" name="NewStatus">
                            @foreach (var status in Model.Statuses)
                            {
                                <option value="@status.Value" selected="@(status.Value == Model.Ticket.Status.ToString())">@status.Text</option>
                            }
                        </select>
                        <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Status</button>
                    </form>

                    <form asp-action="UpdatePriority" method="post" class="mt-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <label class="form-label">Update Priority</label>
                        <select class="form-select" name="NewPriority">
                            @foreach (var priority in Model.Priorities)
                            {
                                <option value="@priority.Value" selected="@(priority.Value == Model.Ticket.Priority.ToString())">@priority.Text</option>
                            }
                        </select>
                        <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Priority</button>
                    </form>

                    <form asp-action="UpdateCategory" method="post" class="mt-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <label class="form-label">Update Category</label>
                        <select class="form-select" name="NewCategoryId">
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.Value" selected="@(category.Value == Model.Ticket.CategoryId.ToString())">@category.Text</option>
                            }
                        </select>
                        <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change Category</button>
                    </form>

                    <form asp-action="UpdateInternalSystem" method="post" class="mt-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <label class="form-label">Update Internal System</label>
                        <select class="form-select" name="NewInternalSystemId">
                            <option value="" selected="@(Model.Ticket.InternalSystemId == null)">Not set</option>
                            @foreach (var system in Model.InternalSystems)
                            {
                                <option value="@system.Value" selected="@(system.Value == Model.Ticket.InternalSystemId?.ToString())">@system.Text</option>
                            }
                        </select>
                        <button class="btn btn-outline-primary mt-2" type="submit" data-loading-text="Updating...">Change System</button>
                    </form>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header section-title">Ticket Overview</div>
                <div class="card-body">
                    <div class="info-grid">
                        <div>
                            <div class="info-label">Requester</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Category</div>
                            <div>@Model.Ticket.Category?.Name</div>
                        </div>
                        <div>
                            <div class="info-label">Internal System</div>
                            <div>@(Model.Ticket.InternalSystem?.Name ?? "Not set")</div>
                        </div>
                        <div>
                            <div class="info-label">Assigned</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.AssignedAdminUser?.DisplayName) ? (Model.Ticket.AssignedAdminUser?.Email ?? "Unassigned") : Model.Ticket.AssignedAdminUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Created</div>
                            <div>@Model.Ticket.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Updated</div>
                            <div>@Model.Ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Reopens</div>
                            <div>@Model.Ticket.ReopenCount</div>
                        </div>
                        @if (Model.Ticket.ReopenedAtUtc.HasValue)
                        {
                            <div>
                                <div class="info-label">Last Reopened</div>
                                <div>@Model.Ticket.ReopenedAtUtc.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                            </div>
                        }
                    <div>
                        <div class="info-label">Status</div>
                        <div class="d-flex gap-2 flex-wrap">
                            @await Html.PartialAsync("_BadgeStatus", Model.Ticket.Status)
                            @await Html.PartialAsync("_BadgePriority", Model.Ticket.Priority)
                        </div>
                    </div>
                    <div>
                        <div class="info-label">Open For</div>
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <span>@SlaHelper.FormatAge(Model.Ticket.CreatedAtUtc, DateTime.UtcNow)</span>
                            @await Html.PartialAsync("_SlaBadge", Model.Ticket)
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 note-card">
                <div class="card-header section-title">Internal Notes</div>
                <div class="card-body">
                    @if (!Model.InternalNotes.Any())
                    {
                        @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                        {
                            Title = "No internal notes",
                            Message = "Admin-only notes stay hidden from requesters."
                        })
                    }
                    else
                    {
                        <div class="comment-timeline">
                            @foreach (var note in Model.InternalNotes)
                            {
                                <div class="comment-card note-card-item">
                                    <div class="comment-header">
                                        <div class="fw-semibold">@(string.IsNullOrWhiteSpace(note.AuthorUser?.DisplayName) ? note.AuthorUser?.Email : note.AuthorUser?.DisplayName)</div>
                                        <div class="ticket-meta">@note.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                                    </div>
                                    <div class="comment-body">@Html.Raw(TicketBodyRenderer.RenderTicketBody(note.Body, Model.AllowedAttachmentIds))</div>
                                    <div class="mt-2">
                                        <button class="btn btn-link btn-sm p-0 edit-link" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#edit-note-@note.Id"
                                                aria-expanded="false"
                                                aria-controls="edit-note-@note.Id">
                                            Edit
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="edit-note-@note.Id">
                                        <form asp-action="EditInternalNote" method="post" data-disable-on-submit>
                                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                                            <input type="hidden" name="noteId" value="@note.Id" />
                                            <div class="mb-2">
                                                <label class="form-label">Edit Internal Note</label>
                                                <textarea class="form-control" name="body" rows="3">@note.Body</textarea>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Changes</button>
                                                <button class="btn btn-sm btn-light" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#edit-note-@note.Id"
                                                        aria-expanded="true"
                                                        aria-controls="edit-note-@note.Id">
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <form asp-action="AddInternalNote" method="post" class="mt-3" data-disable-on-submit>
                        <input type="hidden" name="id" value="@Model.Ticket.Id" />
                        <div class="mb-3">
                            <label class="form-label">Add Internal Note</label>
                            <textarea class="form-control" name="NewInternalNote" rows="3" placeholder="Add internal-only notes" id="note-text"></textarea>
                            <div class="form-text">Tip: paste screenshots here (Ctrl+V).</div>
                            <div class="paste-preview mt-2" id="note-paste-preview"></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" type="submit" data-loading-text="Saving...">Save Note</button>
                            <button class="btn btn-light" type="reset">Clear</button>
                        </div>
                    </form>
                </div>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-header section-title">Actions</div>
                <div class="card-body">
                    @if (Model.Ticket.Status != TicketStatus.Closed)
                    {
                        <form asp-action="Close" method="post" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <button class="btn btn-outline-danger" type="submit" data-loading-text="Closing..." data-confirm="Close this ticket?">Close Ticket</button>
                        </form>
                    }
                    else if (isRequester)
                    {
                        <form asp-action="Reopen" method="post" data-disable-on-submit>
                            <input type="hidden" name="id" value="@Model.Ticket.Id" />
                            <button class="btn btn-outline-secondary" type="submit" data-loading-text="Reopening..." data-confirm="Reopen this ticket?">Reopen Ticket</button>
                        </form>
                    }
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header section-title">Ticket Overview</div>
                <div class="card-body">
                    <div class="info-grid">
                        <div>
                            <div class="info-label">Requester</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.RequesterUser?.DisplayName) ? Model.Ticket.RequesterUser?.Email : Model.Ticket.RequesterUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Category</div>
                            <div>@Model.Ticket.Category?.Name</div>
                        </div>
                        <div>
                            <div class="info-label">Internal System</div>
                            <div>@(Model.Ticket.InternalSystem?.Name ?? "Not set")</div>
                        </div>
                        <div>
                            <div class="info-label">Assigned</div>
                            <div>@(string.IsNullOrWhiteSpace(Model.Ticket.AssignedAdminUser?.DisplayName) ? (Model.Ticket.AssignedAdminUser?.Email ?? "Unassigned") : Model.Ticket.AssignedAdminUser?.DisplayName)</div>
                        </div>
                        <div>
                            <div class="info-label">Created</div>
                            <div>@Model.Ticket.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Updated</div>
                            <div>@Model.Ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                        </div>
                        <div>
                            <div class="info-label">Reopens</div>
                            <div>@Model.Ticket.ReopenCount</div>
                        </div>
                        @if (Model.Ticket.ReopenedAtUtc.HasValue)
                        {
                            <div>
                                <div class="info-label">Last Reopened</div>
                                <div>@Model.Ticket.ReopenedAtUtc.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</div>
                            </div>
                        }
                    <div>
                        <div class="info-label">Status</div>
                        <div class="d-flex gap-2 flex-wrap">
                            @await Html.PartialAsync("_BadgeStatus", Model.Ticket.Status)
                            @await Html.PartialAsync("_BadgePriority", Model.Ticket.Priority)
                        </div>
                    </div>
                    <div>
                        <div class="info-label">Open For</div>
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <span>@SlaHelper.FormatAge(Model.Ticket.CreatedAtUtc, DateTime.UtcNow)</span>
                            @await Html.PartialAsync("_SlaBadge", Model.Ticket)
                        </div>
                    </div>
                    </div>
                </div>
            </div>

        }
    </div>
</div>

@section Scripts {
    @if (TempData["Success"] != null && TempData["Success"]?.ToString() == "Comment posted.")
    {
        <script>
            const thread = document.getElementById("comment-thread");
            if (thread) {
                thread.scrollIntoView({ behavior: "smooth", block: "end" });
            }
        </script>
    }
    <script src="~/js/paste-attachments.js" asp-append-version="true"></script>
    <script>
        initPasteUpload({
            textareaSelector: "#reply-text",
            previewSelector: "#reply-paste-preview",
            uploadUrl: "@Url.Action("UploadToTicket", "Attachments", new { ticketId = Model.Ticket.Id })"
        });

        initPasteUpload({
            textareaSelector: "#note-text",
            previewSelector: "#note-paste-preview",
            uploadUrl: "@Url.Action("UploadToTicket", "Attachments", new { ticketId = Model.Ticket.Id })"
        });
    </script>
}
