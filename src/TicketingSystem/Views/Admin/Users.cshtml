@model IReadOnlyList<UserRoleViewModel>
@using System.Security.Claims
@{
    ViewData["Title"] = "Manage Users";
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;
    var header = new PageHeaderViewModel
    {
        Title = "Users & Roles",
        Subtitle = "Assign Admin or Requester access.",
        Actions = @<a class="btn btn-outline-secondary" asp-action="Categories">Back to Categories</a>
    };
}

@await Html.PartialAsync("_PageHeader", header)

<div class="card">
    <div class="card-header section-title">User Access</div>
    <div class="card-body">
        @if (!Model.Any())
        {
            @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
            {
                Title = "No users found",
                Message = "Create users and assign roles to get started."
            })
        }
        else
        {
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td class="fw-semibold">@(string.IsNullOrWhiteSpace(user.DisplayName) ? user.Email : user.DisplayName)</td>
                            <td class="ticket-meta">@user.Email</td>
                            <td>@user.Role</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-2 flex-wrap">
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="EditUser" asp-route-id="@user.UserId">Edit</a>
                                    <form asp-action="UpdateUserRole" method="post" class="d-flex gap-2" data-disable-on-submit>
                                        <input type="hidden" name="userId" value="@user.UserId" />
                                        <select class="form-select form-select-sm" name="role">
                                            <option value="Requester" selected="@(user.Role == RoleNames.Requester)">Requester</option>
                                            <option value="Admin" selected="@(user.Role == RoleNames.Admin)">Admin</option>
                                        </select>
                                        <button class="btn btn-sm btn-primary" type="submit" data-loading-text="Saving...">Update</button>
                                    </form>
                                    <form asp-action="DeleteUser" method="post" data-disable-on-submit>
                                        <input type="hidden" name="userId" value="@user.UserId" />
                                        <button class="btn btn-sm btn-outline-danger" type="submit"
                                                data-loading-text="Deleting..."
                                                disabled="@(user.UserId == currentUserId)"
                                                onclick="return confirm('Delete this user? This cannot be undone.');">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>
