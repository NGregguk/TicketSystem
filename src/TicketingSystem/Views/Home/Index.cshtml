@model DashboardViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
    var header = new PageHeaderViewModel
    {
        Title = "Dashboard",
        Subtitle = "A quick view of ticket health and what needs attention.",
        Actions = @<a class="btn btn-primary" asp-controller="Tickets" asp-action="Create">Create Ticket</a>
    };
}

@await Html.PartialAsync("_PageHeader", header)

<div class="section-divider"><span>Status Summary</span></div>

<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3 mb-4">
    @foreach (var status in Enum.GetValues<TicketStatus>().Where(s => s != TicketStatus.Resolved))
    {
        <div class="col">
            <a class="card status-card summary-card" asp-controller="Tickets" asp-action="Index" asp-route-status="@status">
                <div class="card-body">
                    <div class="status-card-title">@status</div>
                    <div class="status-card-count">
                        @(Model.StatusCounts.TryGetValue(status, out var count) ? count : 0)
                    </div>
                </div>
            </a>
        </div>
    }
</div>

<div class="section-divider"><span>SLA Summary</span></div>

<div class="row g-3 mb-4">
    <div class="col-lg-4 col-md-6">
        <a class="card sla-summary-card summary-card" asp-controller="Tickets" asp-action="Index">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="sla-summary-label">On Track</div>
                    <div class="sla-summary-count">@Model.OnTrackCount</div>
                </div>
                <span class="badge badge-sla sla-ontrack">On Track</span>
            </div>
        </a>
    </div>
    <div class="col-lg-4 col-md-6">
        <a class="card sla-summary-card summary-card" asp-controller="Tickets" asp-action="Index" asp-route-sla="due">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="sla-summary-label">Due Soon</div>
                    <div class="sla-summary-count">@Model.DueSoonCount</div>
                </div>
                <span class="badge badge-sla sla-duesoon">Due Soon</span>
            </div>
        </a>
    </div>
    <div class="col-lg-4 col-md-6">
        <a class="card sla-summary-card summary-card" asp-controller="Tickets" asp-action="Index" asp-route-sla="overdue">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="sla-summary-label">Overdue</div>
                    <div class="sla-summary-count">@Model.OverdueCount</div>
                </div>
                <span class="badge badge-sla sla-overdue">Overdue</span>
            </div>
        </a>
    </div>
</div>

<div class="section-divider"><span>Workload</span></div>

<div class="row g-4 @(User.IsInRole(RoleNames.Admin) ? "" : "justify-content-center")">
    <div class="col-lg-6 @(User.IsInRole(RoleNames.Admin) ? "" : "col-md-8")">
        <div class="card h-100">
            <div class="card-header section-title">My Open Tickets</div>
            <div class="card-body">
                @if (!Model.MyOpenTickets.Any())
                {
                    @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                    {
                        Title = "No open tickets yet",
                        Message = "Create your first ticket to get support.",
                        ActionText = "Create Ticket",
                        ActionUrl = Url.Action("Create", "Tickets")
                    })
                }
                else
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var ticket in Model.MyOpenTickets)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <a class="fw-semibold" asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id">#@ticket.Id - @ticket.Title</a>
                                    <div class="ticket-meta">@ticket.Category?.Name | Open @SlaHelper.FormatAge(ticket.CreatedAtUtc, DateTime.UtcNow)</div>
                                </div>
                                @await Html.PartialAsync("_BadgeStatus", ticket.Status)
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>

    @if (User.IsInRole(RoleNames.Admin))
    {
        <div class="col-lg-6">
            <div class="card mb-4 h-100">
                <div class="card-header section-title">Unassigned Tickets</div>
                <div class="card-body">
                    @if (!Model.UnassignedTickets.Any())
                    {
                        @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                        {
                            Title = "All tickets are assigned",
                            Message = "No unassigned tickets at the moment."
                        })
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var ticket in Model.UnassignedTickets)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <a class="fw-semibold" asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id">#@ticket.Id - @ticket.Title</a>
                                        <div class="ticket-meta">@ticket.Category?.Name | Open @SlaHelper.FormatAge(ticket.CreatedAtUtc, DateTime.UtcNow)</div>
                                    </div>
                                    @await Html.PartialAsync("_BadgeStatus", ticket.Status)
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card">
                <div class="card-header section-title">Needs Attention</div>
                <div class="card-body">
                    @if (!Model.NeedsAttentionTickets.Any())
                    {
                        @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                        {
                            Title = "No high priority items",
                            Message = "Waiting on user or high priority tickets will show up here."
                        })
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Category</th>
                                        <th>Age</th>
                                        <th>SLA</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ticket in Model.NeedsAttentionTickets)
                                    {
                                        <tr data-row-link data-href="@Url.Action("Details", "Tickets", new { id = ticket.Id })">
                                            <td class="fw-semibold">#@ticket.Id</td>
                                            <td>@ticket.Title</td>
                                            <td>@await Html.PartialAsync("_BadgeStatus", ticket.Status)</td>
                                            <td>@await Html.PartialAsync("_BadgePriority", ticket.Priority)</td>
                                            <td>@ticket.Category?.Name</td>
                                            <td>@SlaHelper.FormatAge(ticket.CreatedAtUtc, DateTime.UtcNow)</td>
                                            <td>@await Html.PartialAsync("_SlaBadge", ticket)</td>
                                            <td>@ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<div class="section-divider"><span>Reporting</span></div>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2 mt-4">
    <div class="section-title">Ticket Volume</div>
    <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Ticket volume range">
            <button class="btn btn-outline-secondary" type="button" data-volume-range="14">14 Days</button>
            <button class="btn btn-outline-secondary" type="button" data-volume-range="30">30 Days</button>
        </div>
        <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-volume-chart">
            Hide Chart
        </button>
    </div>
</div>

<div class="card mb-4" id="volume-chart-card">
    <div class="card-header section-title" id="volume-chart-title">Ticket Volume (Last 14 Days)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="ticket-volume-chart" height="120"></canvas>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">SLA Health</div>
    <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-sla-chart">
        Hide Chart
    </button>
</div>

<div class="card mb-4" id="sla-chart-card">
    <div class="card-header section-title">SLA Health (Open Tickets)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="sla-health-chart" height="120"></canvas>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">Category Mix</div>
    <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-category-chart">
        Hide Chart
    </button>
</div>

<div class="card mb-4" id="category-chart-card">
    <div class="card-header section-title">Top Categories (Open Tickets)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="category-mix-chart" height="140"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const chartCard = document.getElementById("volume-chart-card");
        const chartToggle = document.getElementById("toggle-volume-chart");
        const storedVisibility = localStorage.getItem("dashboardVolumeChart");
        const isVisible = storedVisibility !== "hidden";

        if (chartCard && chartToggle) {
            chartCard.classList.toggle("d-none", !isVisible);
            chartToggle.textContent = isVisible ? "Hide Chart" : "Show Chart";

            chartToggle.addEventListener("click", () => {
                const nowHidden = !chartCard.classList.contains("d-none") ;
                chartCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardVolumeChart", nowHidden ? "hidden" : "visible");
                chartToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const volumeLabels14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeLabels14));
        const volumeCreated14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeCreatedCounts14));
        const volumeClosed14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeClosedCounts14));
        const volumeLabels30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeLabels30));
        const volumeCreated30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeCreatedCounts30));
        const volumeClosed30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeClosedCounts30));

        const ctx = document.getElementById("ticket-volume-chart");
        if (ctx) {
            const chartTitle = document.getElementById("volume-chart-title");
            const rangeButtons = document.querySelectorAll("[data-volume-range]");
            let currentRange = localStorage.getItem("dashboardVolumeRange") || "14";
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            const chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: currentRange === "30" ? volumeLabels30 : volumeLabels14,
                    datasets: [
                        {
                            label: "Created",
                            data: currentRange === "30" ? volumeCreated30 : volumeCreated14,
                            borderColor: isDark ? "#6ea8c7" : "#0f4c6b",
                            backgroundColor: isDark ? "rgba(110, 168, 199, 0.2)" : "rgba(15, 76, 107, 0.15)",
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: "Closed",
                            data: currentRange === "30" ? volumeClosed30 : volumeClosed14,
                            borderColor: isDark ? "#86efac" : "#16a34a",
                            backgroundColor: isDark ? "rgba(134, 239, 172, 0.18)" : "rgba(22, 163, 74, 0.12)",
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });

            const updateRange = (range) => {
                currentRange = range;
                localStorage.setItem("dashboardVolumeRange", range);
                chartInstance.data.labels = range === "30" ? volumeLabels30 : volumeLabels14;
                chartInstance.data.datasets[0].data = range === "30" ? volumeCreated30 : volumeCreated14;
                chartInstance.data.datasets[1].data = range === "30" ? volumeClosed30 : volumeClosed14;
                chartInstance.update();
                if (chartTitle) {
                    chartTitle.textContent = `Ticket Volume (Last ${range} Days)`;
                }
                rangeButtons.forEach((button) => {
                    const isActive = button.getAttribute("data-volume-range") === range;
                    button.classList.toggle("btn-primary", isActive);
                    button.classList.toggle("btn-outline-secondary", !isActive);
                });
            };

            updateRange(currentRange);

            rangeButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    updateRange(button.getAttribute("data-volume-range"));
                });
            });
        }

        const slaCard = document.getElementById("sla-chart-card");
        const slaToggle = document.getElementById("toggle-sla-chart");
        const slaStored = localStorage.getItem("dashboardSlaChart");
        const slaVisible = slaStored !== "hidden";

        if (slaCard && slaToggle) {
            slaCard.classList.toggle("d-none", !slaVisible);
            slaToggle.textContent = slaVisible ? "Hide Chart" : "Show Chart";

            slaToggle.addEventListener("click", () => {
                const nowHidden = !slaCard.classList.contains("d-none");
                slaCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardSlaChart", nowHidden ? "hidden" : "visible");
                slaToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const slaCtx = document.getElementById("sla-health-chart");
        if (slaCtx) {
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            new Chart(slaCtx, {
                type: "doughnut",
                data: {
                    labels: ["On Track", "Due Soon", "Overdue"],
                    datasets: [{
                        data: [@Model.OnTrackCount, @Model.DueSoonCount, @Model.OverdueCount],
                        backgroundColor: isDark
                            ? ["#4ade80", "#fbbf24", "#f87171"]
                            : ["#16a34a", "#f59e0b", "#dc2626"],
                        borderColor: gridColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });
        }

        const categoryCard = document.getElementById("category-chart-card");
        const categoryToggle = document.getElementById("toggle-category-chart");
        const categoryStored = localStorage.getItem("dashboardCategoryChart");
        const categoryVisible = categoryStored !== "hidden";

        if (categoryCard && categoryToggle) {
            categoryCard.classList.toggle("d-none", !categoryVisible);
            categoryToggle.textContent = categoryVisible ? "Hide Chart" : "Show Chart";

            categoryToggle.addEventListener("click", () => {
                const nowHidden = !categoryCard.classList.contains("d-none");
                categoryCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardCategoryChart", nowHidden ? "hidden" : "visible");
                categoryToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const categoryLabels = @Html.Raw(JsonSerializer.Serialize(Model.CategoryLabels));
        const categoryCounts = @Html.Raw(JsonSerializer.Serialize(Model.CategoryCounts));

        const categoryCtx = document.getElementById("category-mix-chart");
        if (categoryCtx) {
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            new Chart(categoryCtx, {
                type: "bar",
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: "Open Tickets",
                        data: categoryCounts,
                        backgroundColor: isDark ? "rgba(110, 168, 199, 0.6)" : "rgba(15, 76, 107, 0.6)",
                        borderColor: isDark ? "#6ea8c7" : "#0f4c6b",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });
        }
    </script>
}
