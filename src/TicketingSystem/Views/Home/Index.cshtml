@model DashboardViewModel
@using System.Text.Json
@{
    ViewData["Title"] = Model.Title;
    var header = new PageHeaderViewModel
    {
        Title = Model.Title,
        Subtitle = Model.Subtitle,
        ScopeNote = Model.ScopeNote,
        Actions = @<a class="btn btn-primary" asp-controller="Tickets" asp-action="Create">Create Ticket</a>
    };
}

@await Html.PartialAsync("_PageHeader", header)

<div class="section-divider"><span>Status Summary</span></div>

<div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-4 summary-row">
    @foreach (var card in Model.StatusCards)
    {
        var href = card.IsClickable && !string.IsNullOrWhiteSpace(card.FilterQueryString)
            ? Url.Action("Index", "Tickets") + card.FilterQueryString
            : string.Empty;
        <div class="col">
            <a class="card status-card summary-card @(card.Count == 0 ? "metric-card-zero" : "")" href="@href">
                <div class="card-body">
                    <div class="status-card-title">@card.Label</div>
                    <div class="status-card-count">
                        @card.Count
                    </div>
                </div>
            </a>
        </div>
    }
</div>

<div class="section-divider"><span>SLA Summary</span></div>

<div class="row g-3 mb-4 summary-row">
    @foreach (var card in Model.SlaCards)
    {
        var href = card.IsClickable && !string.IsNullOrWhiteSpace(card.FilterQueryString)
            ? Url.Action("Index", "Tickets") + card.FilterQueryString
            : string.Empty;
        var badgeClass = card.Key switch
        {
            "ontrack" => "sla-ontrack",
            "due" => "sla-duesoon",
            "overdue" => "sla-overdue",
            _ => "sla-ontrack"
        };
        <div class="col-lg-4 col-md-6">
            <a class="card sla-summary-card summary-card @(card.Count == 0 ? "metric-card-zero" : "")" href="@href">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="sla-summary-label">@card.Label</div>
                        <div class="sla-summary-count">@card.Count</div>
                    </div>
                    <span class="badge badge-sla @badgeClass">@card.Label</span>
                </div>
            </a>
        </div>
    }
</div>

<div class="section-divider"><span>Needs Attention</span></div>

<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header section-title d-flex align-items-center justify-content-between">
                <span>@Model.NeedsAttentionTitle</span>
                @{
                    var needsAttentionHint = Model.IsAdmin
                        ? "Includes Waiting on User, High Priority, or Critical tickets."
                        : "Includes tickets waiting on you, due soon, or overdue.";
                }
                <button type="button"
                        class="btn btn-sm btn-link p-0 text-decoration-none"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="@needsAttentionHint"
                        aria-label="Needs attention criteria">
                    <span class="badge rounded-pill text-bg-secondary">?</span>
                </button>
            </div>
            <div class="card-body">
                @if (!Model.NeedsAttentionTickets.Any())
                {
                    @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                    {
                        Title = Model.NeedsAttentionEmptyTitle,
                        Message = Model.NeedsAttentionEmptyMessage
                    })
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Category</th>
                                    <th>Age</th>
                                    <th>SLA</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ticket in Model.NeedsAttentionTickets)
                                {
                                    <tr data-row-link data-href="@Url.Action("Details", "Tickets", new { id = ticket.Id })">
                                        <td class="fw-semibold">#@ticket.Id</td>
                                        <td>@ticket.Title</td>
                                        <td>@await Html.PartialAsync("_BadgeStatus", ticket.Status)</td>
                                        <td>@await Html.PartialAsync("_BadgePriority", ticket.Priority)</td>
                                        <td>@ticket.Category?.Name</td>
                                        <td>@SlaHelper.FormatAge(ticket.CreatedAtUtc, DateTime.UtcNow)</td>
                                        <td>@await Html.PartialAsync("_SlaBadge", ticket)</td>
                                        <td>@ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="section-divider"><span>Your Work</span></div>

<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header section-title">@Model.MyOpenTicketsTitle</div>
            <div class="card-body">
                @if (!Model.MyOpenTickets.Any())
                {
                    @await Html.PartialAsync("_EmptyState", new EmptyStateViewModel
                    {
                        Title = "No open tickets yet",
                        Message = "Create your first ticket to get support.",
                        ActionText = "Create Ticket",
                        ActionUrl = Url.Action("Create", "Tickets")
                    })
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>SLA</th>
                                    <th>Age</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ticket in Model.MyOpenTickets)
                                {
                                    <tr data-row-link data-href="@Url.Action("Details", "Tickets", new { id = ticket.Id })">
                                        <td class="fw-semibold">#@ticket.Id</td>
                                        <td>
                                            <div class="fw-semibold">@ticket.Title</div>
                                            <div class="ticket-meta">@ticket.Category?.Name</div>
                                        </td>
                                        <td>@await Html.PartialAsync("_BadgeStatus", ticket.Status)</td>
                                        <td>@await Html.PartialAsync("_BadgePriority", ticket.Priority)</td>
                                        <td>@await Html.PartialAsync("_SlaBadge", ticket)</td>
                                        <td>@SlaHelper.FormatAge(ticket.CreatedAtUtc, DateTime.UtcNow)</td>
                                        <td>@ticket.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="section-divider"><span>Reporting</span></div>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2 mt-4">
    <div class="section-title">Ticket Volume</div>
    <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Ticket volume range">
            <button class="btn btn-outline-secondary" type="button" data-volume-range="14">14 Days</button>
            <button class="btn btn-outline-secondary" type="button" data-volume-range="30">30 Days</button>
        </div>
        <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-volume-chart">
            Hide Chart
        </button>
    </div>
</div>

<div class="card mb-4" id="volume-chart-card">
    <div class="card-header section-title" id="volume-chart-title">Ticket Volume (Last 14 Days)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="ticket-volume-chart" height="120"></canvas>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">SLA Health</div>
    <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-sla-chart">
        Hide Chart
    </button>
</div>

<div class="card mb-4" id="sla-chart-card">
    <div class="card-header section-title">SLA Health (Open Tickets)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="sla-health-chart" height="120"></canvas>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="section-title">Category Mix</div>
    <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle-category-chart">
        Hide Chart
    </button>
</div>

<div class="card mb-4" id="category-chart-card">
    <div class="card-header section-title">Top Categories (Open Tickets)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="category-mix-chart" height="140"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const chartCard = document.getElementById("volume-chart-card");
        const chartToggle = document.getElementById("toggle-volume-chart");
        const storedVisibility = localStorage.getItem("dashboardVolumeChart");
        const isVisible = storedVisibility !== "hidden";

        if (chartCard && chartToggle) {
            chartCard.classList.toggle("d-none", !isVisible);
            chartToggle.textContent = isVisible ? "Hide Chart" : "Show Chart";

            chartToggle.addEventListener("click", () => {
                const nowHidden = !chartCard.classList.contains("d-none") ;
                chartCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardVolumeChart", nowHidden ? "hidden" : "visible");
                chartToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const volumeLabels14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeLabels14));
        const volumeCreated14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeCreatedCounts14));
        const volumeClosed14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeClosedCounts14));
        const volumeLabels30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeLabels30));
        const volumeCreated30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeCreatedCounts30));
        const volumeClosed30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeClosedCounts30));
        const volumeDateKeys14 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeDateKeys14));
        const volumeDateKeys30 = @Html.Raw(JsonSerializer.Serialize(Model.VolumeDateKeys30));

        const ctx = document.getElementById("ticket-volume-chart");
        if (ctx) {
            const chartTitle = document.getElementById("volume-chart-title");
            const rangeButtons = document.querySelectorAll("[data-volume-range]");
            let currentRange = localStorage.getItem("dashboardVolumeRange") || "14";
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            const chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: currentRange === "30" ? volumeLabels30 : volumeLabels14,
                    datasets: [
                        {
                            label: "Created",
                            data: currentRange === "30" ? volumeCreated30 : volumeCreated14,
                            borderColor: isDark ? "#6ea8c7" : "#0f4c6b",
                            backgroundColor: isDark ? "rgba(110, 168, 199, 0.2)" : "rgba(15, 76, 107, 0.15)",
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: "Closed",
                            data: currentRange === "30" ? volumeClosed30 : volumeClosed14,
                            borderColor: isDark ? "#86efac" : "#16a34a",
                            backgroundColor: isDark ? "rgba(134, 239, 172, 0.18)" : "rgba(22, 163, 74, 0.12)",
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });

            const updateRange = (range) => {
                currentRange = range;
                localStorage.setItem("dashboardVolumeRange", range);
                chartInstance.data.labels = range === "30" ? volumeLabels30 : volumeLabels14;
                chartInstance.data.datasets[0].data = range === "30" ? volumeCreated30 : volumeCreated14;
                chartInstance.data.datasets[1].data = range === "30" ? volumeClosed30 : volumeClosed14;
                chartInstance.update();
                if (chartTitle) {
                    chartTitle.textContent = `Ticket Volume (Last ${range} Days)`;
                }
                rangeButtons.forEach((button) => {
                    const isActive = button.getAttribute("data-volume-range") === range;
                    button.classList.toggle("btn-primary", isActive);
                    button.classList.toggle("btn-outline-secondary", !isActive);
                });
            };

            updateRange(currentRange);

            rangeButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    updateRange(button.getAttribute("data-volume-range"));
                });
            });

            ctx.onclick = (event) => {
                const points = chartInstance.getElementsAtEventForMode(event, "nearest", { intersect: true }, true);
                if (!points.length) {
                    return;
                }
                const point = points[0];
                const index = point.index;
                const datasetIndex = point.datasetIndex;
                const isCreated = datasetIndex === 0;
                const dateKey = currentRange === "30" ? volumeDateKeys30[index] : volumeDateKeys14[index];
                if (!dateKey) {
                    return;
                }
                const baseUrl = "@Url.Action("Index", "Tickets")";
                const paramName = isCreated ? "createdOn" : "closedOn";
                const target = `${baseUrl}?${paramName}=${encodeURIComponent(dateKey)}`;
                window.location.href = target;
            };
        }

        const slaCard = document.getElementById("sla-chart-card");
        const slaToggle = document.getElementById("toggle-sla-chart");
        const slaStored = localStorage.getItem("dashboardSlaChart");
        const slaVisible = slaStored !== "hidden";

        if (slaCard && slaToggle) {
            slaCard.classList.toggle("d-none", !slaVisible);
            slaToggle.textContent = slaVisible ? "Hide Chart" : "Show Chart";

            slaToggle.addEventListener("click", () => {
                const nowHidden = !slaCard.classList.contains("d-none");
                slaCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardSlaChart", nowHidden ? "hidden" : "visible");
                slaToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const slaCtx = document.getElementById("sla-health-chart");
        if (slaCtx) {
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            const slaChart = new Chart(slaCtx, {
                type: "doughnut",
                data: {
                    labels: ["On Track", "Due Soon", "Overdue"],
                    datasets: [{
                        data: [@Model.OnTrackCount, @Model.DueSoonCount, @Model.OverdueCount],
                        backgroundColor: isDark
                            ? ["#4ade80", "#fbbf24", "#f87171"]
                            : ["#16a34a", "#f59e0b", "#dc2626"],
                        borderColor: gridColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });

            slaCtx.onclick = (event) => {
                const points = slaChart.getElementsAtEventForMode(event, "nearest", { intersect: true }, true);
                if (!points.length) {
                    return;
                }
                const index = points[0].index;
                const slaMap = ["ontrack", "due", "overdue"];
                const slaValue = slaMap[index];
                if (!slaValue) {
                    return;
                }
                const target = "@Url.Action("Index", "Tickets")" + `?sla=${encodeURIComponent(slaValue)}`;
                window.location.href = target;
            };
        }

        const categoryCard = document.getElementById("category-chart-card");
        const categoryToggle = document.getElementById("toggle-category-chart");
        const categoryStored = localStorage.getItem("dashboardCategoryChart");
        const categoryVisible = categoryStored !== "hidden";

        if (categoryCard && categoryToggle) {
            categoryCard.classList.toggle("d-none", !categoryVisible);
            categoryToggle.textContent = categoryVisible ? "Hide Chart" : "Show Chart";

            categoryToggle.addEventListener("click", () => {
                const nowHidden = !categoryCard.classList.contains("d-none");
                categoryCard.classList.toggle("d-none", nowHidden);
                localStorage.setItem("dashboardCategoryChart", nowHidden ? "hidden" : "visible");
                categoryToggle.textContent = nowHidden ? "Show Chart" : "Hide Chart";
            });
        }

        const categoryLabels = @Html.Raw(JsonSerializer.Serialize(Model.CategoryLabels));
        const categoryCounts = @Html.Raw(JsonSerializer.Serialize(Model.CategoryCounts));
        const categoryIds = @Html.Raw(JsonSerializer.Serialize(Model.CategoryIds));

        const categoryCtx = document.getElementById("category-mix-chart");
        if (categoryCtx) {
            const styles = getComputedStyle(document.body);
            const isDark = document.body.classList.contains("dark-mode");
            const textColor = styles.getPropertyValue("--text").trim() || (isDark ? "#e6e7e9" : "#0f172a");
            const gridColor = styles.getPropertyValue("--border").trim() || (isDark ? "#2a2d31" : "#d9dee6");
            const categoryChart = new Chart(categoryCtx, {
                type: "bar",
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: "Open Tickets",
                        data: categoryCounts,
                        backgroundColor: isDark ? "rgba(110, 168, 199, 0.6)" : "rgba(15, 76, 107, 0.6)",
                        borderColor: isDark ? "#6ea8c7" : "#0f4c6b",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });

            categoryCtx.onclick = (event) => {
                const points = categoryChart.getElementsAtEventForMode(event, "nearest", { intersect: true }, true);
                if (!points.length) {
                    return;
                }
                const index = points[0].index;
                const categoryId = categoryIds[index];
                if (!categoryId) {
                    return;
                }
                const target = "@Url.Action("Index", "Tickets")" + `?categoryId=${encodeURIComponent(categoryId)}`;
                window.location.href = target;
            };
        }
    </script>
}
